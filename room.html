<!DOCTYPE html>

<html>

<head>
    <title>Chat App</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/chat.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
     <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    
</head>

<body>

<div class="background"></div>


<section id="chat" class="content">
    <div class="chatrooms">
        <div class="chatroomHeader">
            <h3>Chatrooms</h3>
        </div>
        <div class="chatroomList" id="chatroomList">
            <!--<div class="chatroomListContent" onclick="changeChatroom(1, 'Chatroom 1')">
                <h4>Chatroom 1</h4>
                <p>Status: Inactive</p>
            </div> -->
        </div>
    </div>
    <div class="chatLog">
    
        <div class="chatHeader">
            <div class="" style="flex-shrink: 0;">
                <button onclick="leaveRoom()" type="submit" style="margin-left: 10px; cursor: pointer;">
                    <svg height="50px" width="30px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 304.588 304.588" xml:space="preserve" fill="#000000">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                            <g>
                                <g>
                                    <g>
                                        <polygon style="fill:#010002;" points="134.921,34.204 134.921,54.399 284.398,54.399 284.398,250.183 134.921,250.183 134.921,270.384 304.588,270.384 304.588,34.204 "></polygon>
                                    </g>
                                    <g>
                                        <polygon style="fill:#010002;" points="150.27,223.581 166.615,239.931 254.26,152.286 166.615,64.651 150.27,80.979 210.013,140.733 0,140.733 0,163.838 210.008,163.838 "></polygon>
                                    </g>
                                </g>
                            </g>
                        </g>
                    </svg>
                </button>

                <button id = "deleteButton" onclick="deleteRoom()" type="submit" style="margin-left: 10px; cursor: pointer; display: none">
                    
                    <svg height="50px" width="30px" fill="#ff0000" viewBox="-12.29 -12.29 147.46 147.46" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="enable-background:new 0 0 108.29 122.88" xml:space="preserve" stroke="#ff0000" stroke-width="0.0012288" transform="matrix(1, 0, 0, 1, 0, 0)rotate(0)"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M77.4,49.1h-5.94v56.09h5.94V49.1L77.4,49.1L77.4,49.1z M6.06,9.06h32.16V6.2c0-0.1,0-0.19,0.01-0.29 c0.13-2.85,2.22-5.25,5.01-5.79C43.97-0.02,44.64,0,45.38,0H63.9c0.25,0,0.49-0.01,0.73,0.02c1.58,0.08,3.02,0.76,4.06,1.81 c1.03,1.03,1.69,2.43,1.79,3.98c0.01,0.18,0.02,0.37,0.02,0.55v2.7H103c0.44,0,0.75,0.01,1.19,0.08c2.21,0.36,3.88,2.13,4.07,4.37 c0.02,0.24,0.03,0.47,0.03,0.71v10.54c0,1.47-1.19,2.66-2.67,2.66H2.67C1.19,27.43,0,26.23,0,24.76V24.7v-9.91 C0,10.64,2.04,9.06,6.06,9.06L6.06,9.06z M58.07,49.1h-5.95v56.09h5.95V49.1L58.07,49.1L58.07,49.1z M38.74,49.1H32.8v56.09h5.95 V49.1L38.74,49.1L38.74,49.1z M10.74,31.57h87.09c0.36,0.02,0.66,0.04,1.03,0.1c1.25,0.21,2.4,0.81,3.27,1.66 c1.01,1,1.67,2.34,1.7,3.83c0,0.31-0.03,0.63-0.06,0.95l-7.33,78.66c-0.1,1.03-0.27,1.95-0.79,2.92c-1.01,1.88-2.88,3.19-5.2,3.19 H18.4c-0.55,0-1.05,0-1.59-0.08c-0.22-0.03-0.43-0.08-0.64-0.14c-0.31-0.09-0.62-0.21-0.91-0.35c-0.27-0.13-0.52-0.27-0.78-0.45 c-1.51-1.04-2.51-2.78-2.69-4.72L4.5,37.88c-0.02-0.25-0.04-0.52-0.04-0.77c0.05-1.48,0.7-2.8,1.7-3.79 c0.88-0.86,2.06-1.47,3.33-1.67C9.9,31.59,10.34,31.57,10.74,31.57L10.74,31.57z M97.75,36.9H10.6c-0.57,0-0.84,0.1-0.79,0.7 l7.27,79.05h0l0,0.01c0.03,0.38,0.2,0.69,0.45,0.83l0,0l0.08,0.03l0.06,0.01l0.08,0h72.69c0.6,0,0.67-0.84,0.71-1.28l7.34-78.71 C98.53,37.04,98.23,36.9,97.75,36.9L97.75,36.9z"></path> </g> </g></svg>
                </button>
            </div>
           
            <h3 class="chatroomNames">
                <p id="chatroomName">Real Time Chat Application</p>
                <p class= "aaa" id="chatroomCodess"></p>
            </h3>
            <p class="icons2" id="showUsers"><i class='bx bx-dots-vertical-rounded'></i></p>
        </div>
        <div id="toApprove"></div>
        <div class="chatroomContent" id="chatLog">
            
            <!--<div class="userMsg">
                <div class="name">
                    <p>You</p>
                </div>
                <div class="messagesContent">
                    <p>Baka nmn</p>
                </div>
            </div> -->
        </div>
        <div class="chatMsg">
            <input class="msgInput form-control" placeholder="Aa" id="msgInput">
            <div class="msgSend" onclick="send()"><i class='bx bxs-send'></i></div>
        </div>
    </div>

    <div class="userList" id="activeUserList">
        <div class="userListHeader">
            <h3 id = "titleTag"></h3>
        </div>
        <div class="" style = "height: 30vh; overflow-y: auto; display: none;" id="approveList">
            <!--<div class="chatroomListContent" onclick="changeChatroom(1, 'Chatroom 1')">
                <h4>Chatroom 1</h4>
                <p>Status: Inactive</p>
            </div> -->
        </div>

        <div class="userListHeader">
            <h3 id = "">Users</h3>
        </div>
        <div class="activeUserList" id="userList">
            <!--<div class="chatroomListContent" onclick="changeChatroom(1, 'Chatroom 1')">
                <h4>Chatroom 1</h4>
                <p>Status: Inactive</p>
            </div> -->
        </div>
    </div>
</section>

    <section id="AddChatroomForm" class="popup-form">
        <h1>Add Chatroom</h1>
        <form id="AddChatroom" method="POST" action="">
                <div class="form-field">
                    <label>Chatroom name</label>
                    <input id="ChatroomName" type="text" name="taskName" placeholder="Chatroom name">
                </div>
            </div>
            <div class="addWarning-text">
                <p id="addWarning"></p>
            </div>
            <div class="form-button">
                <input id="addChatroomBtn" type="submit" name="AddChatroom" value="Create">
                <input type="button" value="Cancel" onclick="CloseAddChatroom()">        
            </div>
        </form>
    </section>

    <section id="joinChatroomForm" class="popup-form">
        <h1>Join Chatroom</h1>
        <form id="joinChatroom" method="POST" action="">
                <div class="form-field">
                    <label>Chatroom code</label>
                    <input id="chatroomCode" type="text" name="taskName" placeholder="Chatroom code">
                </div>
            </div>
            <div class="addWarning-text">
                <p id="joinWarning"></p>
            </div>
            <div class="form-button">
                <input id="" type="submit" name="AddChatroom" value="Join">
                <input type="button" value="Cancel" onclick="CloseJoinChatroom()">        
            </div>
        </form>
    </section>

    <section id="add-chatroom" class="add-chatroom-popout">
        <div id="add-chatroom-content" class="content">
            <h3 id = "chatroomCodePrompt"></h3>
            <p>Click anywhere to continue</p>
        </div>
    </section>


</body>
</html>


<script>
    const socket = new WebSocket('ws://192.168.1.103:8080');
    const userList = document.getElementById("userList")
    const isAdmin = false;
    var storedChatLog = []
    var chatrooms = []
    var userStatus = []

    const chatroomCode11 = document.getElementById("chatroomCodess")
    const chatLog = document.getElementById("chatLog")
    const chatroomList = document.getElementById("chatroomList")
    const chatroom = document.getElementById("chatroomName")

    
    const urlParams = new URLSearchParams(window.location.search);
    console.log(urlParams);
    var currentChatroomName = urlParams.get('chatname');
    var currentChatroom = urlParams.get('chatcode');
    var username = urlParams.get('username');
    console.log(currentChatroomName.toString() + " " + currentChatroom.toString())

    setTimeout(function(){ 
        console.log("going down")
        chatLog.scrollTop = chatLog.scrollHeight;
    }, 500);


    changeChatroom(currentChatroom, currentChatroomName)
    var start = false;
    //handles message from the server   

    socket.addEventListener('disconnect', function (event) {
        alert("Disconnected from server")
      
    });
    socket.addEventListener('message', function (event) {
        var messageRecv = JSON.parse(event.data)

        var messageType = messageRecv.type || "";
       
        if (messageType == "alert")
        {
            alert(messageRecv.message)
        }
        else if (messageType == "leaveRoom")
        {
            console.log("Someone has left")
            if (messageRecv.username == username){
                alert("You have been removed from the chatroom")
                window.location.href = "chat.html"
            }
            else{
                alert(messageRecv.username + " has left the chatroom")
            }
            userStatus = userStatus.filter(function(chatroom){
                chatroom.username !== messageType.username
            })
            updateUsers()
            updateChatrooms()
        }
        else if (messageType == "createChatroom" || messageType == "joinChatroom")
        {
            chatrooms.push(messageRecv)
            updateChatrooms()
        }
        else if (messageType == "status")
        {
     
            userStatus.push(messageRecv)
            updateUsers()
            updateChatrooms()
        }
        else if (messageType == "user-chatroom")
        {
            console.log(messageRecv)
            chatrooms.push(messageRecv)
            updateUsers()
            updateChatrooms()
          
        }

        else if (messageType == "removeActive")
        {
            userStatus = userStatus.filter(function(chatroom){
                chatroom.username !== messageType.username
            })
            updateUsers()
            updateChatrooms()
        }
        else if (messageType == "isAllowed"){ 
            if(messageRecv.message == "Allowed"){
                
                return
            }
            else{
                alert("You are not allowed to join this chatroom.")
                window.location.href = "chat.html"
                return
            }
        }
        else if (messageType == "toApprove"){ 
            
           // generate in the message log a notification to the admin that there are users that wants to join 
            console.log(messageRecv)
            var toApprove = document.getElementById("approveList")
            const deleteButton = document.getElementById("deleteButton")
            
            if (messageRecv.message == "No users to approve"){
                deleteButton.style.display = "inline"
                toApprove.style.display = "flex"
                toApprove.innerHTML = ""
                const titleTag = document.getElementById("titleTag") 
                titleTag.innerHTML = `<h4> ${messageRecv.message} </h4>`
                return
            }
            else if (messageRecv.message == "You are not an admin"){
             
                const toApprove  = document.getElementById("approveList")
                toApprove.innerHTML = ""
                return
            }
            else{
                deleteButton.style.display = "inline"
                toApprove.style.display = "flex"
                console.log("pong")
                var div = document.createElement("div");
                div.classList.add("userListContent");
                div.style.display = "flex";
                div.style.justifyContent = "space-between";
                div.style.marginTop = "10px";
                div.style.height = "20px";
                div.style.width = "100%";
                div.innerHTML = `
                    <h4>${messageRecv.username}</h4><button onclick="approveUser('${messageRecv.username}', '${messageRecv.chatcode}')">Approve</button>
                `;
                toApprove.appendChild(div);
                const titleTag = document.getElementById("titleTag") 
                titleTag.innerHTML = `<h4> ${messageRecv.message} </h4>`
            }
            var toApproveCount = toApprove.length 

        }
        else
        {
            // update message
            storedChatLog.push(messageRecv)
            updateMessages()
            chatLog.scrollTop = chatLog.scrollHeight;
        } 
    });

    //initialize the chat app
    function Initialize()
    {
      
        document.getElementById("chat").style.display = "flex"
        start = true
        
        JsonMessage = {"username": username, "type": "isAllowed", "chatcode": currentChatroom}
        JsonMessage = JSON.stringify(JsonMessage)
        JsonMessage2 = {"username": username,  "chatcode" : currentChatroom, "type": "getToApprove"}
        JsonMessage2 = JSON.stringify(JsonMessage2)
        
      
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JsonMessage);
            socket.send(JsonMessage2)
    
        } else {
          
            socket.addEventListener('open', function (event) {
                socket.send(JsonMessage);
                socket.send(JsonMessage2)
       
            

            });
         
        }

       

    }


    function approveUser(username, chatcode){
        console.log(username + " " + chatcode)
        JsonMessage = {"username": username,  "chatcode" : chatcode, "type": "approve"}
        JsonMessage = JSON.stringify(JsonMessage)
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JsonMessage);
        } else {
            console.log('WebSocket is not open. Wait for it to open and then resend the message.');
            // You could set up an event listener here to resend the message when the socket opens
            socket.addEventListener('open', function (event) {
                socket.send(JsonMessage);

            });
         
        }
    }

    
    //change chatroom
    async function changeChatroom(chatroomCode, chatroomName){
        
        

        currentChatroom = chatroomCode
        chatroom.innerHTML = chatroomName 
        chatroomCode11.innerHTML = `${chatroomCode} `
        console.log(userStatus.length)
        if (userStatus.length == 0){ 
            console.log("ping")
            JsonMessage3 = {"username": username,  "chatcode" : currentChatroom, "type": "getChatroomUsers"}
            JsonMessage3 = JSON.stringify(JsonMessage3)
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JsonMessage3);
            } else {
                console.log('WebSocket is not open. Wait for it to open and then resend the message.');
                // You could set up an event listener here to resend the message when the socket opens
                socket.addEventListener('open', function (event) {
                    socket.send(JsonMessage3);
                    socket.send(JSON.stringify({"chatcode": currentChatroom, "username": username, "type": "update"}))
    
                });
             
            }
           
        }
        updateUsers()
        updateMessages()
        updateChatrooms()
        chatLog.scrollTop = chatLog.scrollHeight;

        
    }

    //update message list for each chatroom
    function updateMessages() {
        chatLog.innerHTML = '';
        storedChatLog.forEach(chat => {
            if(chat.chatroom == currentChatroom)
            {
                if(chat.username == username)
                {
                    const message = document.createElement('div');
                    message.classList.add("userMsg")

                    const name = document.createElement('div')
                    name.classList.add("name")
                    const nameP= document.createElement('p');
                    nameP.textContent = "You"
                    name.appendChild(nameP);
                    message.appendChild(name)
                    
                    const content = document.createElement('div')
                    content.classList.add("messagesContent")
                    const contentP = document.createElement('p')
                    contentP.textContent = chat.message;
                    content.appendChild(contentP)
                    message.appendChild(content)
                    
                    chatLog.appendChild(message);
                }
                else
                {
                    const message = document.createElement('div');
                    message.classList.add("messages")

                    const name = document.createElement('div')
                    name.classList.add("name")
                    const nameP= document.createElement('p');
                    nameP.textContent = chat.username
                    name.appendChild(nameP);
                    message.appendChild(name)
                    
                    const content = document.createElement('div')
                    content.classList.add("messagesContent")
                    const contentP = document.createElement('p')
                    contentP.textContent = chat.message;
                    content.appendChild(contentP)
                    message.appendChild(content)
                    
                    chatLog.appendChild(message);
                }
            }
        });
        
    }

   
    function updateUsers() {

        userList.innerHTML = ""
        chatrooms.forEach(users => {
            if(currentChatroom == users.chatcode)
            {
                const user = document.createElement('div');
                user.classList.add("activeUserContent")

                const usernameH4= document.createElement('h4')
                usernameH4.textContent = users.username
                user.appendChild(usernameH4)
                
                const isUserActive= document.createElement('p')

                isActive = false

                if(users.username == username){
                    isActive = true
                }

                userStatus.forEach(user_status => {
                    if(users.username == user_status.username){
                        isActive = true
                    }
                })

                if(!isActive){
                    isUserActive.textContent = "Status: Inactive";
                }
                else{
                    isUserActive.textContent = "Status: Active";
                }

                user.appendChild(isUserActive)

                userList.appendChild(user)
            }
        })
    }
    //update chatroom list
    const chatroomListContent = document.getElementById("chatroomList")
    function updateChatrooms() {
        // remove duplicate chatrooms

        chatroomList.innerHTML = ""

        chatrooms.forEach(rooms => {

            if(rooms.username == username)
            {
                const room = document.createElement('div');
                room.classList.add("chatroomListContent")
                room.onclick = function () {
                    window.location.href = `room.html?chatcode=${rooms.chatcode}&chatname=${rooms.chatname}&username=${username}`
                }

                const roomh4= document.createElement('h4')
                roomh4.textContent = rooms.chatname
                room.appendChild(roomh4)
                
                const roomP= document.createElement('p')

                var isSomeoneActive = false
                chatrooms.forEach(user_rooms => {
                    if(rooms.chatcode == user_rooms.chatcode){
                        console.log(rooms.chatcode, user_rooms.chatcode, userStatus)
                        if (user_rooms.username != username){
                            // alert("same" + rooms.chatcode + " " + user_rooms.chatcode + "in " + user_rooms.username)
                    
                            userStatus.forEach(user_status => {
                                
                                if(user_rooms.username == user_status.username){
                                    isSomeoneActive = true
                                }
                            })
                        }
                    }
                })

                if(!isSomeoneActive){
                    // roomp.classList.add("aaaaa")
                    roomP.textContent = "Status: Inactive";
                }
                else{
                    // roomp.classList.add("aaaaa")
                    roomP.textContent = "Status: Active";
                }
                

                room.appendChild(roomP)
                chatroomList.append(room)
            }
        });
    }

    //send message
    const sendMessage = document.getElementById('sendbtn');
    const messageInput = document.getElementById('msgInput');

    document.getElementById("msgInput").addEventListener('keydown', function(event){
        if (event.keyCode === 13 && start == true) { //13 is for enter
            send()
        }
    })

    function send(){
        var message = messageInput.value.trim(); 
        if(currentChatroom == 0)
        {
            alert("Please select chatroom")
            return
        }

        if (message.length > 0)
        {
            messageInput.value = "";
            JsonMessage = {"chatroom": currentChatroom, "username": username, "message": message, "type": "message"};
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);   
        }


    }

    function leaveRoom(){
        JsonMessage = {"chatcode": currentChatroom, "username": username, "chatname": currentChatroomName,"type": "leaveRoom"};
        socket.send(JSON.stringify(JsonMessage))
    }

    // open add chatroom
    function OpenAddChatroom() {
        document.getElementById("AddChatroomForm").classList.toggle("active");
        document.getElementById("addWarning").innerHTML = "";    //removes the addaddWarning message if there are any
    }

    //close add chatroom
    function CloseAddChatroom(){
        document.getElementById("AddChatroomForm").classList.toggle("active");
        document.getElementById("addWarning").innerHTML = ""; 
    }

    function deleteRoom(){ 
        JsonMessage = {"chatcode": currentChatroom, "username": username, "type": "deleteRoom"};
        socket.send(JSON.stringify(JsonMessage))
        alert("Chatroom has been deleted")
        window.location.href = "chat.html"
    }

    // open join chatroom
    function OpenJoinChatroom() {
        document.getElementById("joinChatroomForm").classList.toggle("active");
        document.getElementById("joinWarning").innerHTML = "";    //removes the addaddWarning message if there are any
    }

    //close join chatroom
    function CloseJoinChatroom(){
        document.getElementById("joinChatroomForm").classList.toggle("active");
        document.getElementById("joinWarning").innerHTML = ""; 
    }

    //add chatroom
    document.getElementById("AddChatroom").addEventListener("submit", function(event) {
        event.preventDefault();
        const chatroomNameInput = document.getElementById("ChatroomName");
        chatroomName = chatroomNameInput.value
        if (chatroomName.length > 0)
        {
            chatroomNameInput.value = ""

            JsonMessage = {"chatroomName": chatroomName, "type": "createChatroom"};
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);

            CloseAddChatroom()
        }
    });

    //join chatroom
    document.getElementById("joinChatroom").addEventListener("submit", function(event) {
        event.preventDefault();
        const joinChatroomInput = document.getElementById("chatroomCode");
        chatroomCode = joinChatroomInput.value
        joinChatroomInput.value = ""


        if (!isNaN(chatroomCode) && chatroomCode.length === 6)
        {
            JsonMessage = {"chatcode": chatroomCode, "username": username, "type": "joinChatroom"}
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);

            CloseJoinChatroom()
        }
        else
        {
            alert("Invalid input.")
        }
    });

    //add chatroom success prompt
    const successPrompt = document.getElementById("add-chatroom");
    const successContent = document.getElementById("add-chatroom-content");

    function checkSuccess() {
        successPrompt.classList.toggle("active");
        successContent.classList.toggle("active");
    }

    successPrompt.addEventListener("click", function() {
        successPrompt.classList.toggle("active");
        successContent.classList.toggle("active");
    })

    document.getElementById("showUsers").addEventListener('click', function(){
        document.getElementById("activeUserList").classList.toggle("active")
       
    })

    Initialize()

    
</script>