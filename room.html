<!DOCTYPE html>

<html>

<head>
    <title>Chat App</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/chat.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
     <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    
</head>

<body>

<div class="background"></div>


<section id="chat" class="content">
  
    <div class="chatLog">
    
        <div class="chatHeader">
            <div id = "toApprove"></div>
            <h3 class="chatroomNamess">
                <p id="chatroomName">Real Time Chat Application</p>
                <p class= "aaa" id="chatroomCodess"></p>
            </h3>
            <p class="icons2" id="showUsers"><i class='bx bx-dots-vertical-rounded'></i></p>
        </div>
        <div id="toApprove"></div>
        <div class="chatroomContent" id="chatLog">
            
            <!--<div class="userMsg">
                <div class="name">
                    <p>You</p>
                </div>
                <div class="messagesContent">
                    <p>Baka nmn</p>
                </div>
            </div> -->
        </div>
        <div class="chatMsg">
            <input class="msgInput" placeholder="Aa" id="msgInput">
            <div class="msgSend" onclick="send()"><i class='bx bxs-send'></i></div>
        </div>
    </div>

    <div class="userList" id="activeUserList">
        <div class="userListHeader">
            <h3 id = "titleTag">Users</h3>
        </div>
        <div class="activeUserList" id="approveList">
            <!--<div class="chatroomListContent" onclick="changeChatroom(1, 'Chatroom 1')">
                <h4>Chatroom 1</h4>
                <p>Status: Inactive</p>
            </div> -->
        </div>

        <div class="activeUserList" id="userList">
            <!--<div class="chatroomListContent" onclick="changeChatroom(1, 'Chatroom 1')">
                <h4>Chatroom 1</h4>
                <p>Status: Inactive</p>
            </div> -->
        </div>
    </div>
</section>

    <section id="AddChatroomForm" class="popup-form">
        <h1>Add Chatroom</h1>
        <form id="AddChatroom" method="POST" action="">
                <div class="form-field">
                    <label>Chatroom name</label>
                    <input id="ChatroomName" type="text" name="taskName" placeholder="Chatroom name">
                </div>
            </div>
            <div class="addWarning-text">
                <p id="addWarning"></p>
            </div>
            <div class="form-button">
                <input id="addChatroomBtn" type="submit" name="AddChatroom" value="Create">
                <input type="button" value="Cancel" onclick="CloseAddChatroom()">        
            </div>
        </form>
    </section>

    <section id="joinChatroomForm" class="popup-form">
        <h1>Join Chatroom</h1>
        <form id="joinChatroom" method="POST" action="">
                <div class="form-field">
                    <label>Chatroom code</label>
                    <input id="chatroomCode" type="text" name="taskName" placeholder="Chatroom code">
                </div>
            </div>
            <div class="addWarning-text">
                <p id="joinWarning"></p>
            </div>
            <div class="form-button">
                <input id="" type="submit" name="AddChatroom" value="Join">
                <input type="button" value="Cancel" onclick="CloseJoinChatroom()">        
            </div>
        </form>
    </section>

    <section id="add-chatroom" class="add-chatroom-popout">
        <div id="add-chatroom-content" class="content">
            <h3 id = "chatroomCodePrompt"></h3>
            <p>Click anywhere to continue</p>
        </div>
    </section>


</body>
</html>


<script>
    const socket = new WebSocket('ws://localhost:8080');
    const userList = document.getElementById("userList")
    const isAdmin = false;
    var storedChatLog = []
    var chatrooms = []
    var userStatus = []
    const chatroomCode11 = document.getElementById("chatroomCodess")
    const chatLog = document.getElementById("chatLog")
    const chatroomList = document.getElementById("chatroomList")
    const chatroom = document.getElementById("chatroomName")

    
    const urlParams = new URLSearchParams(window.location.search);
    console.log(urlParams);
    var currentChatroomName = urlParams.get('chatname');
    var currentChatroom = urlParams.get('chatcode');
    var username = urlParams.get('username');
    console.log(currentChatroomName.toString() + " " + currentChatroom.toString())


    changeChatroom(currentChatroom, currentChatroomName)
    var start = false;
    //handles message from the server   
    socket.addEventListener('message', function (event) {
        var messageRecv = JSON.parse(event.data)

        var messageType = messageRecv.type || "";
       
        if (messageType == "alert")
        {
            alert(messageRecv.message)
        }
        else if (messageType == "status")
        {
            userStatus.push(messageRecv)
            updateUsers()
            updateChatrooms()
            console.log(userStatus)
        }
        else if (messageType == "isAllowed"){ 
            console.log("ping")
            if(messageRecv.message == "Allowed"){
                
                return
            }
            else{
                alert("You are not allowed to join this chatroom.")
                window.location.href = "chat.html"
                return
            }
        }
        else if (messageType == "toApprove"){ 
            
           // generate in the message log a notification to the admin that there are users that wants to join 
            console.log(messageRecv)
            var toApprove = document.getElementById("approveList")
            if (messageRecv.message == "No users to approve"){
                toApprove.innerHTML = ""
                const titleTag = document.getElementById("titleTag") 
                titleTag.innerHTML = `<h4> ${messageRecv.message} </h4>`
                return
            }

            

            else if (messageRecv.message == "You are not an admin"){
                toApprove.innerHTML = ""
                const titleTag = document.getElementById("titleTag") 
                titleTag.innerHTML = `<h4> ${messageRecv.message} </h4>`
                return
            }
            var toApproveCount = toApprove.length 
            var div = document.createElement("div");
            div.classList.add("userListContent");
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
        
            div.style.marginTop = "10px";
            div.style.height = "20px";
            div.style.width = "100%";
            div.innerHTML = `
                <h4>${messageRecv.username}</h4><button onclick="approveUser('${messageRecv.username}', '${messageRecv.chatcode}')">Approve</button>
            `;
            toApprove.appendChild(div);

            const titleTag = document.getElementById("titleTag") 
            titleTag.innerHTML = `<h4> ${messageRecv.message} </h4>`

        }
        else
        {
            // update message
            storedChatLog.push(messageRecv)
            updateMessages()
        } 
    });

    //initialize the chat app
    function Initialize()
    {
      
        document.getElementById("chat").style.display = "flex"
        start = true
        JsonMessage = {"username": username, "type": "isAllowed", "chatcode": currentChatroom}
        JsonMessage = JSON.stringify(JsonMessage)
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JsonMessage);
        } else {
            console.log('WebSocket is not open. Wait for it to open and then resend the message.');
            // You could set up an event listener here to resend the message when the socket opens
            socket.addEventListener('open', function (event) {
                socket.send(JsonMessage);

            });
         
        }
        // setTimeout(updateChatrooms, 300)
    }


    function approveUser(username, chatcode){
        console.log(username + " " + chatcode)
        JsonMessage = {"username": username,  "chatcode" : chatcode, "type": "approve"}
        JsonMessage = JSON.stringify(JsonMessage)
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JsonMessage);
        } else {
            console.log('WebSocket is not open. Wait for it to open and then resend the message.');
            // You could set up an event listener here to resend the message when the socket opens
            socket.addEventListener('open', function (event) {
                socket.send(JsonMessage);

            });
         
        }
    }

    
    //change chatroom
    async function changeChatroom(chatroomCode, chatroomName){
        
        

        currentChatroom = chatroomCode
        chatroom.innerHTML = chatroomName 
        chatroomCode11.innerHTML = " - " + chatroomCode 
        updateUsers()
        updateMessages()
        console.log("Ping")
        JsonMessage = {"username": username,  "chatcode" : currentChatroom, "type": "getToApprove"}
        JsonMessage = JSON.stringify(JsonMessage)
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JsonMessage);
        } else {
            console.log('WebSocket is not open. Wait for it to open and then resend the message.');
            // You could set up an event listener here to resend the message when the socket opens
            socket.addEventListener('open', function (event) {
                socket.send(JsonMessage);

            });
         
        }
    }

    //update message list for each chatroom
    function updateMessages() {
        chatLog.innerHTML = '';
        storedChatLog.forEach(chat => {
            if(chat.chatroom == currentChatroom)
            {
                if(chat.username == username)
                {
                    const message = document.createElement('div');
                    message.classList.add("userMsg")

                    const name = document.createElement('div')
                    name.classList.add("name")
                    const nameP= document.createElement('p');
                    nameP.textContent = "You"
                    name.appendChild(nameP);
                    message.appendChild(name)
                    
                    const content = document.createElement('div')
                    content.classList.add("messagesContent")
                    const contentP = document.createElement('p')
                    contentP.textContent = chat.message;
                    content.appendChild(contentP)
                    message.appendChild(content)
                    
                    chatLog.appendChild(message);
                }
                else
                {
                    const message = document.createElement('div');
                    message.classList.add("messages")

                    const name = document.createElement('div')
                    name.classList.add("name")
                    const nameP= document.createElement('p');
                    nameP.textContent = chat.username
                    name.appendChild(nameP);
                    message.appendChild(name)
                    
                    const content = document.createElement('div')
                    content.classList.add("messagesContent")
                    const contentP = document.createElement('p')
                    contentP.textContent = chat.message;
                    content.appendChild(contentP)
                    message.appendChild(content)
                    
                    chatLog.appendChild(message);
                }
            }
        });
    }

   
    function updateUsers() {
        userList.innerHTML = ""
        chatrooms.forEach(users => {
            if(currentChatroom == users.chatcode)
            {
                const user = document.createElement('div');
                user.classList.add("activeUserContent")

                const usernameH4= document.createElement('h4')
                usernameH4.textContent = users.username
                user.appendChild(usernameH4)
                
                const isUserActive= document.createElement('p')

                isActive = false

                if(users.username == username){
                    isActive = true
                }

                userStatus.forEach(user_status => {
                    if(users.username == user_status.username){
                        isActive = true
                    }
                })

                if(!isActive){
                    isUserActive.textContent = "Status: Inactive";
                }
                else{
                    isUserActive.textContent = "Status: Active";
                }

                user.appendChild(isUserActive)

                userList.appendChild(user)
            }
        })
    }
    //update chatroom list
    function updateChatrooms() {
        chatroomList.innerHTML = '';
        chatrooms.forEach(rooms => {
            if(rooms.username == username)
            {
                const room = document.createElement('div');
                room.classList.add("chatroomListContent")
                room.onclick = function () {
                    changeChatroom(rooms.chatcode, rooms.chatname)
                }

                const roomh4= document.createElement('h4')
                roomh4.textContent = rooms.chatname
                room.appendChild(roomh4)
                
                const roomP= document.createElement('p')

                var isSomeoneActive = false
                chatrooms.forEach(user_rooms => {
                    if(rooms.chatcode == user_rooms.chatcode){
                        if (user_rooms.username != username){
                            // alert("same" + rooms.chatcode + " " + user_rooms.chatcode + "in " + user_rooms.username)
                            userStatus.forEach(user_status => {
                                if(user_rooms.username == user_status.username){
                                    isSomeoneActive = true
                                }
                            })
                        }
                    }
                })

                if(!isSomeoneActive){
                    // roomp.classList.add("aaaaa")
                    roomP.textContent = "Status: Inactive";
                }
                else{
                    // roomp.classList.add("aaaaa")
                    roomP.textContent = "Status: Active";
                }
                

                room.appendChild(roomP)
                
                chatroomList.appendChild(room);
            }
        });
    }

    //send message
    const sendMessage = document.getElementById('sendbtn');
    const messageInput = document.getElementById('msgInput');

    document.getElementById("msgInput").addEventListener('keydown', function(event){
        if (event.keyCode === 13 && start == true) { //13 is for enter
            send()
        }
    })

    function send(){
        var message = messageInput.value.trim(); 
        if(currentChatroom == 0)
        {
            alert("Please select chatroom")
            return
        }

        if (message.length > 0)
        {
            messageInput.value = "";

            JsonMessage = {"chatroom": currentChatroom, "username": username, "message": message, "type": "message"};
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);   
        }
    }

    // open add chatroom
    function OpenAddChatroom() {
        document.getElementById("AddChatroomForm").classList.toggle("active");
        document.getElementById("addWarning").innerHTML = "";    //removes the addaddWarning message if there are any
    }

    //close add chatroom
    function CloseAddChatroom(){
        document.getElementById("AddChatroomForm").classList.toggle("active");
        document.getElementById("addWarning").innerHTML = ""; 
    }

    // open join chatroom
    function OpenJoinChatroom() {
        document.getElementById("joinChatroomForm").classList.toggle("active");
        document.getElementById("joinWarning").innerHTML = "";    //removes the addaddWarning message if there are any
    }

    //close join chatroom
    function CloseJoinChatroom(){
        document.getElementById("joinChatroomForm").classList.toggle("active");
        document.getElementById("joinWarning").innerHTML = ""; 
    }

    //add chatroom
    document.getElementById("AddChatroom").addEventListener("submit", function(event) {
        event.preventDefault();
        const chatroomNameInput = document.getElementById("ChatroomName");
        chatroomName = chatroomNameInput.value
        if (chatroomName.length > 0)
        {
            chatroomNameInput.value = ""

            JsonMessage = {"chatroomName": chatroomName, "type": "createChatroom"};
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);

            CloseAddChatroom()
        }
    });

    //join chatroom
    document.getElementById("joinChatroom").addEventListener("submit", function(event) {
        event.preventDefault();
        const joinChatroomInput = document.getElementById("chatroomCode");
        chatroomCode = joinChatroomInput.value
        joinChatroomInput.value = ""


        if (!isNaN(chatroomCode) && chatroomCode.length === 6)
        {
            JsonMessage = {"chatcode": chatroomCode, "username": username, "type": "joinChatroom"}
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);

            CloseJoinChatroom()
        }
        else
        {
            alert("Invalid input.")
        }
    });

    //add chatroom success prompt
    const successPrompt = document.getElementById("add-chatroom");
    const successContent = document.getElementById("add-chatroom-content");

    function checkSuccess() {
        successPrompt.classList.toggle("active");
        successContent.classList.toggle("active");
    }

    successPrompt.addEventListener("click", function() {
        successPrompt.classList.toggle("active");
        successContent.classList.toggle("active");
    })

    document.getElementById("showUsers").addEventListener('click', function(){
        document.getElementById("activeUserList").classList.toggle("active")
       
    })

    Initialize()

    
</script>