<!DOCTYPE html>

<html>

<head>
    <title>Chat App</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/chat.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
     <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
</head>

<body>

<div class="background"></div>

<section id = "hero" class="hero">
    <div class="form-box">
        <div class="hero-header">
            Real time chat app
        </div>
        <div class="button-box">
            <button id="loginBtn" type="button" class="toggle-btn active" onclick="login()">Log In</button>
            <button id="signupBtn" type="button" class="toggle-btn" onclick="register()">Register</button>
        </div>
            <form id="login" class="input-group">
                <p class="icons"><i class='bx bxs-user'></i></p>
                <input id="login-username" type="text" class="input-field" placeholder="Username" required>
                <p class="icons"><i class='bx bxs-lock-alt' ></i></p>
                <input id="login-password" type="password" class="input-field" placeholder="Password" required>
                <button type="submit" class="submit-btn">Log In</button>
            </form>
            <form id="register"class="input-group">
                <p class="icons"><i class='bx bxs-user'></i></p>
                <input id = "signup-username" type="text" class="input-field" placeholder="Username" required>
                <p class="icons"><i class='bx bxs-lock-alt' ></i></p>
                <input id = "signup-password" type="password" class="input-field" placeholder="Password" required>
                <p class="icons"><i class='bx bxs-lock-alt' ></i></p>
                <input id = "signup-rpt-password" type="password" class="input-field" placeholder="Repeat password" required>
                <button type="submit" class="submit-btn">Register</button>
            </form>
    </div>
</section>

<section id="chat" class="content">
  

  

    
    <div class="chatLog">
        <div style="position: absolute; width: 100vw; height: 40%; margin-top: 10vh;">
            
            <div class="addChatIcon" onclick="OpenAddChatroom()">
                <div class="btn" style = "margin-top: 10vh; margin-bottom: 10vh;">
                    Create Room
                </div>
            </div>
            <div class="joinChatIcon" onclick="OpenJoinChatroom()">
                <div class="btn" style = "margin-bottom: 10vh;">
                    Join Chatroom
                </div>
            </div>
            <div class="chatroomList" id="chatroomList" style="overflow-y: auto; height: 30vh;">
                
            </div>  
        </div>
        <div class="chatHeader">
            <h3 class="chatroomNamess">
                <p id="chatroomName">Real Time Chat Application</p>
                <p class= "aaa" id="chatroomCodess"></p>
            </h3>
            <p class="icons2" id="showUsers"><i class='bx bx-dots-vertical-rounded'></i></p>
        </div>
        <div class="chatroomContent" id="chatLog">
            <!--<div class="userMsg">
                <div class="name">
                    <p>You</p>
                </div>
                <div class="messagesContent">
                    <p>Baka nmn</p>
                </div>
            </div> -->
        </div>
        <div class="chatMsg" style = "display: none;">
            <input class="msgInput" placeholder="Aa" id="msgInput">
            <div class="msgSend" onclick="send()"><i class='bx bxs-send'></i></div>
        </div>
    </div>

    <div class="userList" id="activeUserList">
        <div class="userListHeader">
            <h3>Users</h3>
        </div>
        <div class="activeUserList" id="userList">
            <!--<div class="chatroomListContent" onclick="changeChatroom(1, 'Chatroom 1')">
                <h4>Chatroom 1</h4>
                <p>Status: Inactive</p>
            </div> -->
        </div>
    </div>
</section>

    <section id="AddChatroomForm" class="popup-form">
        <h1>Add Chatroom</h1>
        <form id="AddChatroom" method="POST" action="">
                <div class="form-field">
                    <label>Chatroom name</label>
                    <input id="ChatroomName" type="text" name="taskName" placeholder="Chatroom name">
                </div>
            </div>
            <div class="addWarning-text">
                <p id="addWarning"></p>
            </div>
            <div class="form-button">
                <input id="addChatroomBtn" type="submit" name="AddChatroom" value="Create">
                <input type="button" value="Cancel" onclick="CloseAddChatroom()">        
            </div>
        </form>
    </section>

    <section id="joinChatroomForm" class="popup-form">
        <h1>Join Chatroom</h1>
        <form id="joinChatroom" method="POST" action="">
                <div class="form-field">
                    <label>Chatroom code</label>
                    <input id="chatroomCode" type="text" name="taskName" placeholder="Chatroom code">
                </div>
            </div>
            <div class="addWarning-text">
                <p id="joinWarning"></p>
            </div>
            <div class="form-button">
                <input id="" type="submit" name="AddChatroom" value="Join">
                <input type="button" value="Cancel" onclick="CloseJoinChatroom()">        
            </div>
        </form>
    </section>

    <section id="add-chatroom" class="add-chatroom-popout">
        <div id="add-chatroom-content" class="content">
            <h3 id = "chatroomCodePrompt"></h3>
            <p>Click anywhere to continue</p>
        </div>
    </section>


</body>
</html>


<script>
    const socket = new WebSocket('ws://localhost:8080');

    var storedChatLog = []
    var chatrooms = []
    var userStatus = []

    const chatLog = document.getElementById("chatLog")
    const chatroomList = document.getElementById("chatroomList")
    const chatroom = document.getElementById("chatroomName")

    var username = "";
    var currentChatroom = 0;
    var start = false;

    //handles message from the server   
    socket.addEventListener('message', function (event) {
        var messageRecv = JSON.parse(event.data)

        var messageType = messageRecv.type || "";
        if(messageType == "newChatroom")
        {
            var chatroomCodePrompt = document.getElementById("chatroomCodePrompt")
            chatroomCodePrompt.textContent = "Your chatroom code is " + messageRecv.chatcode
            checkSuccess()
        }
        else if (messageType == "user-chatroom")
        {
            chatrooms.push(messageRecv)
            console.log(chatrooms)
            updateUsers()
            updateChatrooms()
        }
        else if (messageType == "login")
        {
            username = messageRecv.username
            console.log("welcome " + username)
            Initialize()
        }
        else if (messageType == "alert")
        {
            alert(messageRecv.message)
        }
        else if (messageType == "status")
        {
            userStatus.push(messageRecv)
            updateUsers()
            updateChatrooms()
            console.log(userStatus)
        }
        else if (messageType == "removeActive")
        {
            userStatus = userStatus.filter(function(chatroom){
                chatroom.username !== messageType.username
            })
            updateUsers()
            updateChatrooms()
        }
        else
        {
            // update message
            storedChatLog.push(messageRecv)
            updateMessages()
        }

        
    });

    //initialize the chat app
    function Initialize()
    {
        document.getElementById("hero").style.display = "none"
        document.getElementById("chat").style.display = "flex"
        document.getElementById("profile").setAttribute("title", username)
    
        start = true
        // setTimeout(updateChatrooms, 300)
    }

    const chatroomCode11 = document.getElementById("chatroomCodess")
    //change chatroom
    function changeChatroom(chatroomCode, chatroomName){
        currentChatroom = chatroomCode
        chatroom.innerHTML = chatroomName 
        chatroomCode11.innerHTML = " - " + chatroomCode 
        updateUsers()
        updateMessages()
        window.location.href = "room.html?chatname=" + chatroomName + "&chatcode=" + chatroomCode + "&username=" + username
    }

    //update message list for each chatroom
    function updateMessages() {
        chatLog.innerHTML = '';
        storedChatLog.forEach(chat => {
            if(chat.chatroom == currentChatroom)
            {
                if(chat.username == username)
                {
                    const message = document.createElement('div');
                    message.classList.add("userMsg")

                    const name = document.createElement('div')
                    name.classList.add("name")
                    const nameP= document.createElement('p');
                    nameP.textContent = "You"
                    name.appendChild(nameP);
                    message.appendChild(name)
                    
                    const content = document.createElement('div')
                    content.classList.add("messagesContent")
                    const contentP = document.createElement('p')
                    contentP.textContent = chat.message;
                    content.appendChild(contentP)
                    message.appendChild(content)
                    
                    chatLog.appendChild(message);
                }
                else
                {
                    const message = document.createElement('div');
                    message.classList.add("messages")

                    const name = document.createElement('div')
                    name.classList.add("name")
                    const nameP= document.createElement('p');
                    nameP.textContent = chat.username
                    name.appendChild(nameP);
                    message.appendChild(name)
                    
                    const content = document.createElement('div')
                    content.classList.add("messagesContent")
                    const contentP = document.createElement('p')
                    contentP.textContent = chat.message;
                    content.appendChild(contentP)
                    message.appendChild(content)
                    
                    chatLog.appendChild(message);
                }
            }
        });
    }

    const userList = document.getElementById("userList")
    function updateUsers() {
        userList.innerHTML = ""
        chatrooms.forEach(users => {
            if(currentChatroom == users.chatcode)
            {
                const user = document.createElement('div');
                user.classList.add("activeUserContent")

                const usernameH4= document.createElement('h4')
                usernameH4.textContent = users.username
                user.appendChild(usernameH4)
                
                const isUserActive= document.createElement('p')

                isActive = false

                if(users.username == username){
                    isActive = true
                }

                userStatus.forEach(user_status => {
                    if(users.username == user_status.username){
                        isActive = true
                    }
                })

                if(!isActive){
                    isUserActive.textContent = "Status: Inactive";
                }
                else{
                    isUserActive.textContent = "Status: Active";
                }

                user.appendChild(isUserActive)

                userList.appendChild(user)
            }
        })
    }
    //update chatroom list
    function updateChatrooms() {
        chatroomList.innerHTML = '';
        chatrooms.forEach(rooms => {
            if(rooms.username == username)
            {
                const room = document.createElement('div');
                room.classList.add("chatroomListContent")
                room.onclick = function () {
                    changeChatroom(rooms.chatcode, rooms.chatname)
                }

                const roomh4= document.createElement('h4')
                roomh4.textContent = rooms.chatname
                room.appendChild(roomh4)
                
                const roomP= document.createElement('p')

                var isSomeoneActive = false
                chatrooms.forEach(user_rooms => {
                    if(rooms.chatcode == user_rooms.chatcode){
                        if (user_rooms.username != username){
                            // alert("same" + rooms.chatcode + " " + user_rooms.chatcode + "in " + user_rooms.username)
                            userStatus.forEach(user_status => {
                                if(user_rooms.username == user_status.username){
                                    isSomeoneActive = true
                                }
                            })
                        }
                    }
                })

                if(!isSomeoneActive){
                    // roomp.classList.add("aaaaa")
                    roomP.textContent = "Status: Inactive";
                }
                else{
                    // roomp.classList.add("aaaaa")
                    roomP.textContent = "Status: Active";
                }
                

                room.appendChild(roomP)
                
                chatroomList.appendChild(room);
            }
        });
    }

    //send message
    const sendMessage = document.getElementById('sendbtn');
    const messageInput = document.getElementById('msgInput');

    document.getElementById("msgInput").addEventListener('keydown', function(event){
        if (event.keyCode === 13 && start == true) { //13 is for enter
            send()
        }
    })

    function send(){
        var message = messageInput.value.trim(); 
        if(currentChatroom == 0)
        {
            alert("Please select chatroom")
            return
        }

        if (message.length > 0)
        {
            messageInput.value = "";

            JsonMessage = {"chatroom": currentChatroom, "username": username, "message": message, "type": "message"};
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);   
        }
    }

    // open add chatroom
    function OpenAddChatroom() {
        document.getElementById("AddChatroomForm").classList.toggle("active");
        document.getElementById("addWarning").innerHTML = "";    //removes the addaddWarning message if there are any
    }

    //close add chatroom
    function CloseAddChatroom(){
        document.getElementById("AddChatroomForm").classList.toggle("active");
        document.getElementById("addWarning").innerHTML = ""; 
    }

    // open join chatroom
    function OpenJoinChatroom() {
        document.getElementById("joinChatroomForm").classList.toggle("active");
        document.getElementById("joinWarning").innerHTML = "";    //removes the addaddWarning message if there are any
    }

    //close join chatroom
    function CloseJoinChatroom(){
        document.getElementById("joinChatroomForm").classList.toggle("active");
        document.getElementById("joinWarning").innerHTML = ""; 
    }

    //add chatroom
    document.getElementById("AddChatroom").addEventListener("submit", function(event) {
        event.preventDefault();
        const chatroomNameInput = document.getElementById("ChatroomName");
        chatroomName = chatroomNameInput.value
        if (chatroomName.length > 0)
        {
            chatroomNameInput.value = ""

            JsonMessage = {"chatroomName": chatroomName, "type": "createChatroom"};
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);

            CloseAddChatroom()
        }
    });

    //join chatroom
    document.getElementById("joinChatroom").addEventListener("submit", function(event) {
        event.preventDefault();
        const joinChatroomInput = document.getElementById("chatroomCode");
        chatroomCode = joinChatroomInput.value
        joinChatroomInput.value = ""


        if (!isNaN(chatroomCode) && chatroomCode.length === 6)
        {
            JsonMessage = {"chatcode": chatroomCode, "username": username, "type": "joinChatroom"}
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);

            CloseJoinChatroom()
        }
        else
        {
            alert("Invalid input.")
        }
    });

    //add chatroom success prompt
    const successPrompt = document.getElementById("add-chatroom");
    const successContent = document.getElementById("add-chatroom-content");

    function checkSuccess() {
        successPrompt.classList.toggle("active");
        successContent.classList.toggle("active");
    }

    successPrompt.addEventListener("click", function() {
        successPrompt.classList.toggle("active");
        successContent.classList.toggle("active");
    })

    // login-signup js
    var x = document.getElementById("login");
    var y = document.getElementById("register");
    const loginBtn = document.getElementById("loginBtn")
    const signupBtn = document.getElementById("signupBtn")


    function register (){
        loginUsername.value = ""
        loginPassword.value = ""

        x.style.left = "-400px";
        y.style.left = "50px";
        loginBtn.classList.remove("active")
        signupBtn.classList.add("active")
    }
    function login (){
        signupUsername.value = ""  
        signupPassword.value = ""
        signupRptPassword.value = ""

        x.style.left = "50px";
        y.style.left = "450px";
        loginBtn.classList.add("active")
        signupBtn.classList.remove("active")
    }

    // login
    const loginUsername = document.getElementById("login-username")
    const loginPassword = document.getElementById("login-password")

    document.getElementById("login").addEventListener("submit", function(event) {
        event.preventDefault();
        var loginUsernameInput = loginUsername.value
        var loginPasswordInput = loginPassword.value

        JsonMessage = {"username": loginUsernameInput,  "password": loginPasswordInput, "type": "loginUser"}
        JsonMessage = JSON.stringify(JsonMessage)
        socket.send(JsonMessage);

        console.log("Logging in...")
    });

    loginPassword.addEventListener('input', function(e){
        if(loginPassword.value.length > 10){
            
            loginPassword.value = loginPassword.value.slice(0, 10)
        }
    })

    msgInput.addEventListener('input', function(e){
        if(msgInput.value.length > 50){
            
            msgInput.value = msgInput.value.slice(0, 50)
        }
    })

    // register
    const signupUsername = document.getElementById("signup-username")
    const signupPassword = document.getElementById("signup-password")
    const signupRptPassword = document.getElementById("signup-rpt-password")

    signupUsername.addEventListener('input', function(e){
        if(signupUsername.value.length > 10){
            
            signupUsername.value = signupUsername.value.slice(0, 10)
        }
    })

    signupPassword.addEventListener('input', function(e){
        if(signupPassword.value.length > 10){
            
            signupPassword.value = signupPassword.value.slice(0, 10)
        }
    })

    signupRptPassword.addEventListener('input', function(e){
        if(signupRptPassword.value.length > 10){
            
            signupRptPassword.value = signupRptPassword.value.slice(0, 10)
        }
    })

    ChatroomName.addEventListener('input', function(e){
        if(ChatroomName.value.length > 10){
            
            ChatroomName.value = ChatroomName.value.slice(0, 10)
        }
    })

    ChatroomName.addEventListener('input', function(e){
        if(ChatroomName.value.length > 10){
            
            ChatroomName.value = ChatroomName.value.slice(0, 10)
        }
    })

    document.getElementById("register").addEventListener('submit', function(e){
        e.preventDefault();
        var UsernameInput = signupUsername.value.trim()
        var passwordInput = signupPassword.value
        var rptPasswordInput = signupRptPassword.value

        if(passwordInput !== rptPasswordInput){
            alert("Your password doesn't match.")
        }
        else
        {
            login()
            
            JsonMessage = {"username": UsernameInput,  "password": passwordInput, "type": "signupUser"}
            JsonMessage = JSON.stringify(JsonMessage)
            socket.send(JsonMessage);

            console.log("Signing in...")
        }
    })

    document.getElementById("showUsers").addEventListener('click', function(){
        document.getElementById("activeUserList").classList.toggle("active")
    })

    // logout
    function logout(){
        JsonMessage = {"type": "logout"}
        JsonMessage = JSON.stringify(JsonMessage)
        socket.send(JsonMessage);
        
        location.reload()
    }
</script>